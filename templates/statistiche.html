<!DOCTYPE html><html lang="en"><head>    <meta charset="UTF-8">    <meta http-equiv="X-UA-Compatible" content="IE=edge">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>FlipInClassIA - Dashboard</title>    <!-- Favicon -->    <link rel="shortcut icon" href="../static/dashboardStaticFile/img/svg/Logo.svg" type="image/x-icon">    <!-- Custom styles -->    <link rel="stylesheet" href="../static/dashboardStaticFile/css/style.min.css">    <!-- Include Chart.js versione 3+ -->    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1"></script>    <!-- Include Moment.js -->    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>    <!-- Include l'adattatore per Chart.js per moment.js -->    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0"></script>    <style>        /* CSS personalizzato per il layout */        .charts-container {            display: flex;            flex-wrap: wrap;            gap: 20px;            justify-content: center;        }        .chart-item {            flex: 1 1 30%; /* Imposta tutti i grafici della stessa dimensione */            min-width: 300px;        }        .main-title {            text-align: center;            margin-bottom: 20px;        }        /* Stile per i filtri e il pulsante di esportazione */        .bottom-right {            display: flex;            flex-direction: column;            gap: 10px;            background: #fff;            padding: 15px;            border-radius: 8px;            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);            position: relative;            margin-top: 20px;            align-self: flex-end;            width: fit-content;        }        .bottom-right select,        .bottom-right button {            padding: 10px;            border-radius: 5px;            border: 1px solid #ccc;            background-color: #f8f9fa;            cursor: pointer;        }        .bottom-right button {            background-color: #007bff;            color: white;            border: none;            transition: background-color 0.3s;        }        .bottom-right button:hover {            background-color: #0056b3;        }    </style></head><body><div class="layer"></div><a class="skip-link sr-only" href="#skip-target">Skip to content</a><div class="page-flex">    {% include 'side-bar.html' %}    <div class="main-wrapper">        {% include 'main-nav.html' %}        <main class="main users chart-page" id="skip-target">            <div class="container">                <h2 class="main-title">Statistiche</h2>                <!-- Sezione Statistiche Aggregate -->                <div class="row stat-cards">                    <div class="col-md-6 col-xl-3">                        <article class="stat-cards-item">                            <div class="stat-cards-icon primary">                                <i data-feather="bar-chart-2" aria-hidden="true"></i>                            </div>                            <div class="stat-cards-info">                                <p id="total-questions" class="stat-cards-info__title">                                    Numero Totale di Domande: 0                                </p>                            </div>                        </article>                    </div>                    <div class="col-md-6 col-xl-3">                        <article class="stat-cards-item">                            <div class="stat-cards-icon success">                                <i data-feather="check-circle" aria-hidden="true"></i>                            </div>                            <div class="stat-cards-info">                                <p id="total-correct-answers" class="stat-cards-info__title">                                    Risposte Corrette: 0                                </p>                                <p class="stat-cards-info__progress">                            <span class="stat-cards-info__profit success">                                <i data-feather="trending-up" aria-hidden="true"></i>                                Aggiornato adesso                            </span>                                </p>                            </div>                        </article>                    </div>                    <div class="col-md-6 col-xl-3">                        <article class="stat-cards-item">                            <div class="stat-cards-icon danger">                                <i data-feather="x-circle" aria-hidden="true"></i>                            </div>                            <div class="stat-cards-info">                                <p id="total-incorrect-answers" class="stat-cards-info__title">                                    Risposte Errate: 0                                </p>                                <p class="stat-cards-info__progress">                            <span class="stat-cards-info__profit danger">                                <i data-feather="trending-down" aria-hidden="true"></i>                                Aggiornato adesso                            </span>                                </p>                            </div>                        </article>                    </div>                    <div class="col-md-6 col-xl-3">                        <article class="stat-cards-item">                            <div class="stat-cards-icon warning">                                <i data-feather="percent" aria-hidden="true"></i>                            </div>                            <div class="stat-cards-info">                                <p id="average-score" class="stat-cards-info__title">                                    Punteggio Medio: 0.0%                                </p>                                <p class="stat-cards-info__progress">                            <span class="stat-cards-info__profit warning">                                <i data-feather="trending-up" aria-hidden="true"></i>                                Aggiornato adesso                            </span>                                </p>                            </div>                        </article>                    </div>                </div>                <!-- Contenitore grafici con Flexbox -->                <div class="charts-container">                    <div class="chart-item">                        <canvas id="punteggioChart"></canvas>                    </div>                    <div class="chart-item">                        <canvas id="risposteChart"></canvas>                    </div>                    <div class="chart-item">                        <canvas id="varianzaChart"></canvas>                    </div>                </div>                <!-- Sezione per Feedback Studente in forma di tabella -->                <div class="users-table table-wrapper">                    <h3>Feedback dello Studente</h3>                    <br>                    <table class="posts-table">                        <thead>                            <tr class="users-table-info">                                <th>Data</th>                                <th>Feedback</th>                            </tr>                        </thead>                        <tbody id="feedback-table-body">                            <!-- Le righe della tabella saranno generate dinamicamente -->                        </tbody>                    </table>                </div>                <!-- Contenitore filtri ed esportazione -->                <div class="bottom-right">                    <div class="filter-container">                        <label for="time-period">Seleziona il periodo:</label>                        <select id="time-period">                            <option value="all">Tutto</option>                            <option value="week">Ultima settimana</option>                            <option value="month">Ultimo mese</option>                            <option value="year">Ultimo anno</option>                        </select>                        <label for="lesson-filter">Seleziona la lezione:</label>                        <select id="lesson-filter">                            <option value="all">Tutte</option>                            <!-- Opzioni generate dinamicamente -->                        </select>                    </div>                    <!-- Pulsante per esportare i dati -->                    <button id="export-data" class="btn">Esporta Dati in CSV</button>                </div>            </div>        </main>        <script>            const userType = "{{ user_type }}";            const statisticheQuestionario = {{ statistiche_questionario | tojson }};            const statisticheStudente = {{ statistiche_studente | tojson }};            document.addEventListener('DOMContentLoaded', function () {                let labels = [];                let punteggi = [];                let varianze = [];                let risposteCorrette = [];                let risposteErrate = [];                let totalQuestions = 0;                let totalCorrectAnswers = 0;                let totalIncorrectAnswers = 0;                let averageScore = 0;                let feedback = '';                let label = '';                // Variabili per confronto mensile                let currentMonthCorrect = 0;                let previousMonthCorrect = 0;                let currentMonthIncorrect = 0;                let previousMonthIncorrect = 0;                let currentMonthScores = [];                let previousMonthScores = [];                const now = new Date();                const currentMonth = now.getMonth();                const currentYear = now.getFullYear();                const previousMonthDate = new Date(now.setMonth(currentMonth - 1));                const previousMonth = previousMonthDate.getMonth();                const previousYear = previousMonthDate.getFullYear();                if (userType === 'docente') {                    statisticheQuestionario.forEach(item => {                        const date = new Date(item.data);                        const month = date.getMonth();                        const year = date.getFullYear();                        labels.push(date.toISOString().split('T')[0]);                        punteggi.push(item.punteggio_medio);                        varianze.push(item.varianza_punteggio);                        risposteCorrette.push(item.risposte_corrette);                        risposteErrate.push(item.risposte_errate);                        totalQuestions += item.numero_domande;                        totalCorrectAnswers += item.risposte_corrette;                        totalIncorrectAnswers += item.risposte_errate;                        // Calcola i dati per il mese corrente e precedente                        if (year === currentYear && month === currentMonth) {                            currentMonthCorrect += item.risposte_corrette;                            currentMonthIncorrect += item.risposte_errate;                            currentMonthScores.push(item.punteggio_medio);                        } else if (year === previousYear && month === previousMonth) {                            previousMonthCorrect += item.risposte_corrette;                            previousMonthIncorrect += item.risposte_errate;                            previousMonthScores.push(item.punteggio_medio);                        }                    });                    averageScore = (totalCorrectAnswers / (totalCorrectAnswers + totalIncorrectAnswers) * 100).toFixed(2);                } else if (userType === 'studente') {                    statisticheStudente.forEach(item => {                        const date = new Date(item.data);                        const month = date.getMonth();                        const year = date.getFullYear();                        labels.push(date.toISOString().split('T')[0]);                        punteggi.push(item.punteggio);                        risposteCorrette.push(item.risposte_corrette);                        risposteErrate.push(item.risposte_errate);                        totalCorrectAnswers += item.risposte_corrette;                        totalIncorrectAnswers += item.risposte_errate;                        feedback = item.feedback_suggerito;                        // Calcola i dati per il mese corrente e precedente                        if (year === currentYear && month === currentMonth) {                            currentMonthCorrect += item.risposte_corrette;                            currentMonthIncorrect += item.risposte_errate;                            currentMonthScores.push(item.punteggio);                        } else if (year === previousYear && month === previousMonth) {                            previousMonthCorrect += item.risposte_corrette;                            previousMonthIncorrect += item.risposte_errate;                            previousMonthScores.push(item.punteggio);                        }                    });                    totalQuestions = totalCorrectAnswers + totalIncorrectAnswers;                    averageScore = (totalCorrectAnswers / totalQuestions * 100).toFixed(2);                }                // Calcola la differenza per le risposte corrette e errate                const correctDifference = currentMonthCorrect - previousMonthCorrect;                const incorrectDifference = currentMonthIncorrect - previousMonthIncorrect;                // Calcola il punteggio medio per il mese corrente e precedente                const currentMonthAverageScore = currentMonthScores.length > 0 ?                    (currentMonthScores.reduce((a, b) => a + b, 0) / currentMonthScores.length).toFixed(2) : 0;                const previousMonthAverageScore = previousMonthScores.length > 0 ?                    (previousMonthScores.reduce((a, b) => a + b, 0) / previousMonthScores.length).toFixed(2) : 0;                // Calcola la differenza del punteggio medio                const averageScoreDifference = (currentMonthAverageScore - previousMonthAverageScore).toFixed(2);                // Determina se c'è stato un miglioramento o peggioramento                const correctTrend = correctDifference >= 0 ? 'up' : 'down';                const incorrectTrend = incorrectDifference >= 0 ? 'up' : 'down';                const averageScoreTrend = averageScoreDifference >= 0 ? 'up' : 'down';                // Aggiorna le statistiche aggregate                document.getElementById('total-questions').textContent = `Numero totale di domande: ${totalQuestions}`;                document.getElementById('total-correct-answers').textContent = `Risposte Corrette: ${totalCorrectAnswers}`;                document.getElementById('total-incorrect-answers').textContent = `Risposte Errate: ${totalIncorrectAnswers}`;                document.getElementById('average-score').textContent = `Punteggio Medio: ${averageScore}%`;                // Aggiorna la sezione per il miglioramento/peggioramento delle risposte corrette e errate                document.querySelector('#total-correct-answers + .stat-cards-info__progress').innerHTML = `                        <span class="stat-cards-info__profit ${correctTrend === 'up' ? 'success' : 'danger'}">                            <i data-feather="trending-${correctTrend}" aria-hidden="true"></i>                            ${correctTrend === 'up' ? 'Miglioramento' : 'Peggioramento'}: ${Math.abs(correctDifference)} rispetto al mese precedente                        </span>                    `;                document.querySelector('#total-incorrect-answers + .stat-cards-info__progress').innerHTML = `                        <span class="stat-cards-info__profit ${incorrectTrend === 'down' ? 'success' : 'danger'}">                            <i data-feather="trending-${incorrectTrend}" aria-hidden="true"></i>                            ${incorrectTrend === 'down' ? 'Miglioramento' : 'Peggioramento'}: ${Math.abs(incorrectDifference)} rispetto al mese precedente                        </span>                    `;                // Aggiorna la sezione per il miglioramento/peggioramento del punteggio medio                document.querySelector('#average-score + .stat-cards-info__progress').innerHTML = `                        <span class="stat-cards-info__profit ${averageScoreTrend === 'up' ? 'success' : 'danger'}">                            <i data-feather="trending-${averageScoreTrend}" aria-hidden="true"></i>                            ${averageScoreTrend === 'up' ? 'Miglioramento' : 'Peggioramento'}: ${Math.abs(averageScoreDifference)}% rispetto al mese precedente                        </span>                    `;                // Re-inizializza le icone di Feather                feather.replace();                // Crea la tabella dei feedback                function populateFeedbackTable(statisticheStudente) {                    const feedbackTableBody = document.getElementById('feedback-table-body');                    feedbackTableBody.innerHTML = ''; // Svuota la tabella prima di aggiungere i nuovi dati                    statisticheStudente.forEach(item => {                        if (item.feedback_suggerito) { // Solo se il feedback non è nullo                            const row = document.createElement('tr');                            const dateCell = document.createElement('td');                            const feedbackCell = document.createElement('td');                            // Aggiungi la data e il feedback alla riga                            dateCell.textContent = new Date(item.data).toISOString().split('T')[0];                            feedbackCell.textContent = item.feedback_suggerito;                            row.appendChild(dateCell);                            row.appendChild(feedbackCell);                            feedbackTableBody.appendChild(row);                        }                    });                }                if (userType === 'studente') {                    populateFeedbackTable(statisticheStudente);                } else {                    document.querySelector('.users-table').style.display = 'none';                }                // Esporta dati in CSV                document.getElementById('export-data').addEventListener('click', function () {                    let csvContent = "data:text/csv;charset=utf-8,Data,Punteggio,Varianza,Risposte Corrette,Risposte Errate\n";                    labels.forEach((label, index) => {                        csvContent += `${label},${punteggi[index] || ''},${varianze[index] || ''},${risposteCorrette[index]},${risposteErrate[index]}\n`;                    });                    const encodedUri = encodeURI(csvContent);                    const link = document.createElement("a");                    link.setAttribute("href", encodedUri);                    link.setAttribute("download", "statistiche.csv");                    document.body.appendChild(link);                    link.click();                });                // Creazione dei grafici                let punteggioChart, varianzaChart, risposteChart;                function createCharts(labels, punteggi, varianze, risposteCorrette, risposteErrate) {                    const ctx1 = document.getElementById('punteggioChart').getContext('2d');                    punteggioChart = new Chart(ctx1, {                        type: 'line',                        data: {                            labels: labels,                            datasets: [{                                label: label,                                data: punteggi,                                borderColor: 'rgba(75, 192, 192, 1)',                                fill: false                            }]                        },                        options: {                            responsive: true,                            plugins: {                                title: {                                    display: true,                                    text: userType === 'docente' ? 'Punteggio Medio del Corso nel Tempo' : 'Punteggio dello Studente nel Tempo'                                }                            },                            scales: {                                x: {                                    type: 'time',                                    time: {                                        unit: 'day',                                        displayFormats: {                                            day: 'YYYY-MM-DD'                                        },                                        tooltipFormat: 'YYYY-MM-DD'                                    }                                }                            }                        }                    });                    if (userType === 'docente') {                        const ctx2 = document.getElementById('varianzaChart').getContext('2d');                        varianzaChart = new Chart(ctx2, {                            type: 'line',                            data: {                                labels: labels,                                datasets: [{                                    label: 'Varianza Punteggio',                                    data: varianze,                                    borderColor: 'rgba(192, 75, 192, 1)',                                    fill: false                                }]                            },                            options: {                                responsive: true,                                plugins: {                                    title: {                                        display: true,                                        text: 'Varianza del Punteggio del Corso nel Tempo'                                    }                                },                                scales: {                                    x: {                                        type: 'time',                                        time: {                                            unit: 'day',                                            displayFormats: {                                                day: 'YYYY-MM-DD'                                            },                                            tooltipFormat: 'YYYY-MM-DD'                                        }                                    }                                }                            }                        });                    }                    const ctx3 = document.getElementById('risposteChart').getContext('2d');                    risposteChart = new Chart(ctx3, {                        type: 'bar',                        data: {                            labels: labels,                            datasets: [                                {                                    label: 'Risposte Corrette',                                    data: risposteCorrette,                                    backgroundColor: 'rgba(75, 192, 192, 0.5)'                                },                                {                                    label: 'Risposte Errate',                                    data: risposteErrate,                                    backgroundColor: 'rgba(192, 75, 75, 0.5)'                                }                            ]                        },                        options: {                            responsive: true,                            plugins: {                                title: {                                    display: true,                                    text: 'Numero di Risposte Corrette ed Errate nel Tempo'                                }                            },                            scales: {                                x: {                                    type: 'time',                                    time: {                                        unit: 'day',                                        displayFormats: {                                            day: 'YYYY-MM-DD'                                        },                                        tooltipFormat: 'YYYY-MM-DD'                                    }                                }                            }                        }                    });                }                // Inizializzazione dei grafici con i dati iniziali                createCharts(labels, punteggi, varianze, risposteCorrette, risposteErrate);                // Funzione per aggiornare i grafici in base ai filtri selezionati                document.getElementById('time-period').addEventListener('change', function () {                    applyFilters();                });                document.getElementById('lesson-filter').addEventListener('change', function () {                    applyFilters();                });                function applyFilters() {                    const period = document.getElementById('time-period').value;                    const selectedLesson = document.getElementById('lesson-filter').value;                    let filteredLabels = [];                    let filteredPunteggi = [];                    let filteredVarianze = [];                    let filteredRisposteCorrette = [];                    let filteredRisposteErrate = [];                    const now = new Date();                    const oneWeekAgo = new Date(now);                    oneWeekAgo.setDate(now.getDate() - 7);                    const oneMonthAgo = new Date(now);                    oneMonthAgo.setMonth(now.getMonth() - 1);                    const oneYearAgo = new Date(now);                    oneYearAgo.setFullYear(now.getFullYear() - 1);                    labels.forEach((label, index) => {                        const labelDate = new Date(label);                        const includeDate = (                            (period === 'all') ||                            (period === 'week' && labelDate >= oneWeekAgo) ||                            (period === 'month' && labelDate >= oneMonthAgo) ||                            (period === 'year' && labelDate >= oneYearAgo)                        );                        const includeLesson = (selectedLesson === 'all' || selectedLesson === labels[index]);                        if (includeDate && includeLesson) {                            filteredLabels.push(label);                            filteredPunteggi.push(punteggi[index]);                            if (userType === 'docente') {                                filteredVarianze.push(varianze[index]);                            }                            filteredRisposteCorrette.push(risposteCorrette[index]);                            filteredRisposteErrate.push(risposteErrate[index]);                        }                    });                    // Aggiorna i grafici con i dati filtrati                    updateCharts(filteredLabels, filteredPunteggi, filteredVarianze, filteredRisposteCorrette, filteredRisposteErrate);                }                function updateCharts(labels, punteggi, varianze, risposteCorrette, risposteErrate) {                    // Aggiorna il grafico dei punteggi                    punteggioChart.data.labels = labels;                    punteggioChart.data.datasets[0].data = punteggi;                    punteggioChart.update();                    // Aggiorna il grafico delle varianze (solo per il docente)                    if (userType === 'docente') {                        varianzaChart.data.labels = labels;                        varianzaChart.data.datasets[0].data = varianze;                        varianzaChart.update();                    }                    // Aggiorna il grafico delle risposte                    risposteChart.data.labels = labels;                    risposteChart.data.datasets[0].data = risposteCorrette;                    risposteChart.data.datasets[1].data = risposteErrate;                    risposteChart.update();                }            })            ;        </script>        {% include 'footerDash.html' %}    </div></div><script src="../static/dashboardStaticFile/plugins/feather.min.js"></script><script src="../static/dashboardStaticFile/js/script.js"></script></body></html>