<!DOCTYPE html><html lang="en"><head>    <meta charset="UTF-8">    <meta http-equiv="X-UA-Compatible" content="IE=edge">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>FlipInClassIA - Dashboard</title>    <!-- Favicon -->    <link rel="shortcut icon" href="../static/dashboardStaticFile/img/svg/Logo.svg" type="image/x-icon">    <!-- Custom styles -->    <link rel="stylesheet" href="../static/dashboardStaticFile/css/style.min.css"></head><body><div class="layer"></div><!-- ! Body --><div class="page-flex">    <div class="main-wrapper">        <!-- ! Main nav -->        {% include 'main-nav-lezioni.html' %}        <div class="quiz-container-unique" id="quiz-container">            <div class="timer-unique" id="timer"></div>            <div class="question-unique" id="question">Domanda 1: Qual è la capitale d'Italia?</div>            <ul class="options-unique" id="options">                <!-- Le opzioni verranno inserite dinamicamente -->            </ul>            <div class="btn-container-unique">                <button class="button-unique" id="skipBtn">Salta</button>                <button class="button-unique" id="submitBtn">Invia Risposta</button>            </div>            <div class="nav-buttons">                <button id="prevBtn" class="button-unique arrow-btn" disabled>◀</button>                <button id="nextBtn" class="button-unique arrow-btn">▶</button>            </div>        </div>        <div class="review-container-unique" id="review-container">            <div class="review-header-unique">                <h2>Resoconto</h2>                <span class="review-timer-unique" id="review-timer"></span>            </div>            <div id="review-questions">                <!-- Le domande e risposte del resoconto verranno inserite dinamicamente -->            </div>            <div class="final-btns-unique">                <button class="button-unique" id="modifyBtn">Modifica Risposte</button>                <button class="button-unique" id="finalSubmitBtn">Invia Questionario</button>            </div>        </div>    </div></div><!-- Chart library --><script src="../static/dashboardStaticFile/plugins/chart.min.js"></script><!-- Icons library --><script src="../static/dashboardStaticFile/plugins/feather.min.js"></script><!-- Custom scripts --><script src="../static/dashboardStaticFile/js/script.js"></script><script>    let questions = []; // Definiamo `questions` solo una volta    let avvio_primaFase = 0;    let avvio_secondaFase = 0;    function ottieni_questionario() {        const lezione_id = {{ lezione_id | tojson | default('null') }};        fetch('/ottieni_questionario', {            method: 'POST',            headers: {                'Content-Type': 'application/json'            },            body: JSON.stringify({'lezione_id': lezione_id})        })            .then(response => response.json())            .then(data => {                if (data.error) {                    console.error('Errore nel caricamento del questionario:', data.error);                    return;                }                // Costruisce l'array 'questions' con i dati ricevuti                questions = data.domande.map(domanda => {                    return {                        domanda_id: domanda.domanda_id, // Includi l'ID della domanda                        question: domanda.testo_domanda,                        options: domanda.opzioni.map(opzione => ({                            testo: opzione.testo_opzione,                            opzione_id: opzione.opzione_id // Includi l'ID dell'opzione                        })),                        correct: domanda.opzioni.find(opzione => opzione.opzione_id === domanda.corretta_opzione_id).testo_opzione                    };                });                if (questions && questions.length > 0) {                    currentQuestionIndex = 0; // Resetta l'indice delle domande                    loadQuestion(currentQuestionIndex); // Carica la prima domanda                } else {                    console.error('Nessuna domanda trovata.');                }            })            .catch(error => console.error('Errore nel recupero del questionario:', error));    }    let currentQuestionIndex = 0;    let timeLeft;    let interval;    let selectedAnswers = [];    const quizContainer = document.getElementById('quiz-container');    const reviewContainer = document.getElementById('review-container');    const timerElem = document.getElementById('timer');    const reviewTimerElem = document.getElementById('review-timer');    const submitBtn = document.getElementById('submitBtn');    const skipBtn = document.getElementById('skipBtn');    const prevBtn = document.getElementById('prevBtn');    const nextBtn = document.getElementById('nextBtn');    const questionElem = document.getElementById('question');    const optionsElem = document.getElementById('options');    const reviewQuestionsElem = document.getElementById('review-questions');    const finalSubmitBtn = document.getElementById('finalSubmitBtn');    const modifyBtn = document.getElementById('modifyBtn');    const toggleDarkModeBtn = document.getElementById('toggleDarkMode');    function loadQuestion(index) {        if (!questions || questions.length === 0 || index >= questions.length) {            console.error('L\'array delle domande non è stato popolato correttamente o l\'indice è fuori dai limiti.');            return;        }        const questionData = questions[index];        questionElem.textContent = `${index + 1}. ${questionData.question}`;        optionsElem.innerHTML = ''; // Svuota le opzioni precedenti        questionData.options.forEach((option) => {            const li = document.createElement('li');            li.textContent = option.testo;            li.classList.add('option-item-unique');            if (selectedAnswers[index] && selectedAnswers[index].opzione_id === option.opzione_id) {                li.classList.add('selected-unique');            }            li.addEventListener('click', () => selectAnswer(index, option));            optionsElem.appendChild(li);        });        updateNavButtons(index);    }    function selectAnswer(index, option) {        selectedAnswers[index] = {            testo: option.testo,            opzione_id: option.opzione_id        };        const options = optionsElem.querySelectorAll('li');        options.forEach(li => li.classList.remove('selected-unique'));        options.forEach(li => {            if (li.textContent === option.testo) {                li.classList.add('selected-unique');            }        });    }    function startTimer(lessonStatus) {        let startTime, endTime;        // Determine the start time based on lesson status        if (lessonStatus === 3) {            startTime = avvio_primaFase        } else if (lessonStatus === 5) {            startTime = avvio_secondaFase        }        console.log("startTime: " + startTime);        console.log("tempoQuestions: " + questions.length * 45);        // Calculate the end time        endTime = startTime + questions.length * 45;        console.log("endTime: " + endTime);        // Calculate the remaining time in seconds        const now = Math.floor(Date.now() / 1000); // Current time in seconds        console.log("now: " + now);        timeLeft = endTime - now;        console.log("timeLeft: " + timeLeft);        if (timeLeft < 0) {            timeLeft = 0;        }        console.log("timeLeft2: " + timeLeft);        interval = setInterval(() => {            timeLeft--;            timerElem.textContent = timeLeft;            reviewTimerElem.textContent = timeLeft;            if (timeLeft > questions.length * 45 * 0.66) {                timerElem.style.color = 'green';                reviewTimerElem.style.color = 'green';            } else if (timeLeft > questions.length * 45 * 0.33) {                timerElem.style.color = 'orange';                reviewTimerElem.style.color = 'orange';            } else {                timerElem.style.color = 'red';                reviewTimerElem.style.color = 'red';            }            if (timeLeft <= 0) {                clearInterval(interval);                inviaQuestionario();            }        }, 1000);    }    let statoPrecedente = 0;    function aggiorna_dati_studenti() {        fetch('aggiorna_dati_studenti', {            method: 'POST',            headers: {                'Content-Type': 'application/json'            },            body: JSON.stringify({                'lezione_id': {{ lezione_id | tojson | default('null') }},                'questionario_id': {{ questionario_id | tojson | default('null') }}            })        })// Cambia con il percorso API corretto            .then(response => response.json())            .then(data => {                const lessonStatus = data.statolezione;                avvio_primaFase = data.avvio_primaFase;                avvio_secondaFase = data.avvio_secondaFase;                console.log("avvio_primaFase: " + avvio_primaFase);                console.log("avvio_secondaFase: " + avvio_secondaFase);                console.log("statoPrecedente: " + statoPrecedente);                console.log("lessonStatus: " + lessonStatus);                if (lessonStatus !== statoPrecedente) {                    console.log("sono entrato");                    if (lessonStatus === 1 || lessonStatus === 7) {                        // Esegui il comando /lezioni in app.py                        const corso_id = {{ corso_id | tojson | default('null') }};                        window.location.href = `/lezioni?corso_id=${corso_id}`;                    } else if (lessonStatus === 2 || lessonStatus === 4 || lessonStatus === 6) {                        // Mostra un div per attesa                        document.getElementById('quiz-container').style.display = 'none';                        document.getElementById('review-container').style.display = 'none';                        document.getElementById('waiting-div').style.display = 'block';                    } else if (lessonStatus === 3 || lessonStatus === 5) {                        startTimer(lessonStatus);                        // Mostra il div del questionario                        if (window.getComputedStyle(document.getElementById('review-container')).display === 'block') {                            document.getElementById('quiz-container').style.display = 'none';                        } else {                            document.getElementById('quiz-container').style.display = 'block';                        }                        document.getElementById('waiting-div').style.display = 'none';                    }                }                statoPrecedente = lessonStatus;            })            .catch(error => console.error('Errore nel recupero dello stato della lezione:', error));    }    function toggleDarkMode() {        document.body.classList.toggle('dark-mode');    }    function nextQuestion() {        if (currentQuestionIndex < questions.length - 1) {            currentQuestionIndex++;            loadQuestion(currentQuestionIndex);        } else {            showReview();        }    }    function showReview() {        quizContainer.style.display = 'none';        reviewContainer.style.display = 'block';        loadReview();    }    function loadReview() {        reviewQuestionsElem.innerHTML = '';        questions.forEach((questionData, index) => {            const reviewItem = document.createElement('div');            reviewItem.classList.add('review-item-unique');            reviewItem.innerHTML = `<strong>${index + 1}. ${questionData.question}</strong><ul class="review-options-unique"></ul>`;            questionData.options.forEach(option => {                const li = document.createElement('li');                li.textContent = option.testo; // Accesso alla proprietà `testo` dell'oggetto opzione                li.classList.add('option-item-unique');                if (selectedAnswers[index] && selectedAnswers[index].opzione_id === option.opzione_id) {                    li.classList.add('selected-unique');                }                reviewItem.querySelector('.review-options-unique').appendChild(li);            });            reviewQuestionsElem.appendChild(reviewItem);        });    }    function updateNavButtons(index) {        prevBtn.disabled = index === 0;        nextBtn.disabled = index === questions.length - 1;    }    function inviaQuestionario() {        clearInterval(interval);        finalSubmitBtn.disabled = true;        modifyBtn.disabled = true;        // Crea un array con tutte le risposte selezionate        const risposteStudente = questions.map((question, index) => {            return {                domanda_id: question.domanda_id, // Includi l'ID della domanda                opzione_scelta_id: selectedAnswers[index] ? selectedAnswers[index].opzione_id : null, // Includi l'ID dell'opzione scelta                risposta: selectedAnswers[index] ? selectedAnswers[index].testo : null, // Testo della risposta                corretta: question.correct            };        });        // Invia le risposte al server        fetch('/invia_questionario', {            method: 'POST',            headers: {                'Content-Type': 'application/json'            },            body: JSON.stringify({                'lezione_id': {{ lezione_id | tojson | default('null') }},                'questionario_id': {{ questionario_id | tojson | default('null') }}, // Includi questionario_id nel payload                'studente_id': {{ user_id | tojson | default('null') }},                'risposte': risposteStudente            })        })            .then(response => response.json())            .then(data => {                if (data.success) {                    alert('Questionario inviato con successo!');                } else {                    console.error('Errore nell\'invio del questionario:', data.error);                    alert('Errore durante l\'invio del questionario. Riprova.');                }            })            .catch(error => {                console.error('Errore nel comunicare con il server:', error);                alert('Errore nel comunicare con il server. Riprova.');            });        showReview();    }    finalSubmitBtn.addEventListener('click', () => {        inviaQuestionario();    });    modifyBtn.addEventListener('click', () => {        reviewContainer.style.display = 'none';        quizContainer.style.display = 'block';        loadQuestion(currentQuestionIndex);    });    submitBtn.addEventListener('click', nextQuestion);    skipBtn.addEventListener('click', nextQuestion);    prevBtn.addEventListener('click', () => {        currentQuestionIndex--;        loadQuestion(currentQuestionIndex);    });    nextBtn.addEventListener('click', () => {        currentQuestionIndex++;        loadQuestion(currentQuestionIndex);    });    toggleDarkModeBtn.addEventListener('click', toggleDarkMode);    // Aggiungi il div per la visualizzazione dello stato in attesa    document.addEventListener('DOMContentLoaded', () => {        if (myApp.darkModePubblic === 'enabled') {            toggleDarkMode();        }        const waitingDiv = document.createElement('div');        waitingDiv.id = 'waiting-div';        waitingDiv.style.display = 'none';        waitingDiv.innerHTML = `        <div class="waiting-content">            <div class="loader"></div>            <p class="waiting-text">LEZIONE IN ATTESA</p>        </div>    `;        document.body.appendChild(waitingDiv);        ottieni_questionario();        // Controllo iniziale dello stato della lezione        aggiorna_dati_studenti();        // Imposta il controllo dello stato ogni 5 secondi        setInterval(aggiorna_dati_studenti, 5000);    });</script></body></html>